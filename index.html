<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æŠ•è³‡ç›£æ§ä¸­å¿ƒ</title>
  <style>
    body { font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif; margin: 24px; color:#111; }
    h1 { margin: 0 0 12px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin: 10px 0 18px; }
    .btn { display:inline-block; padding:10px 12px; border:1px solid #ddd; border-radius:12px; text-decoration:none; color:#111; }
    .card { border:1px solid #eee; border-radius:16px; padding:14px 16px; margin-top:14px; }
    .muted { color:#666; font-size:14px; }
    ul { margin: 10px 0 0 18px; }
    li { margin: 6px 0; }
    .tag { font-size:12px; padding:2px 8px; border:1px solid #ddd; border-radius:999px; margin-left:8px; color:#444; }
    .pill { font-size:12px; padding:2px 8px; border:1px solid #ddd; border-radius:999px; color:#444; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 860px) { .grid { grid-template-columns: 1fr 1fr; } }
    code { background:#f7f7f7; padding: 2px 6px; border-radius: 8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <h1>ğŸ“Š æˆ‘çš„æŠ•è³‡ç›£æ§ä¸­å¿ƒ</h1>

  <div class="row">
    <a class="btn" href="https://mis23ms.github.io/tw-stock-06/" target="_blank" rel="noopener">è‚¡ç¥¨å¤–è³‡æˆ°å ±</a>
    <a class="btn" href="https://mis23ms.github.io/tw-stock-futures/" target="_blank" rel="noopener">æœŸè²¨å¤§é¡äº¤æ˜“äºº</a>
    <a class="btn" href="https://mis23ms.github.io/tw-stock-options/" target="_blank" rel="noopener">é¸æ“‡æ¬Šå¤§é¡äº¤æ˜“äºº</a>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="align-items:center; margin:0;">
        <h2 style="margin:0;">âš ï¸ ä»Šæ—¥é‡é»</h2>
        <span id="count" class="pill">0</span>
      </div>
      <div id="status" class="muted" style="margin-top:6px;">è¼‰å…¥ä¸­â€¦</div>
      <ul id="highlights"></ul>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px;">ğŸ•’ æœ€æ–°æ›´æ–°</h2>
      <div id="updatedAt" class="muted">â€”</div>

      <div class="muted" style="margin-top:10px;">
        å„ä¾†æºæ›´æ–°æ™‚é–“ï¼š
        <div id="perSource" class="mono" style="margin-top:6px; line-height:1.7;"></div>
      </div>

      <div class="muted" style="margin-top:10px;">
        è³‡æ–™ä¾†æºï¼ˆJSONï¼‰ï¼š
        <div style="margin-top:6px; line-height:1.7;">
          <div>â€¢ <code id="u1"></code></div>
          <div>â€¢ <code id="u2"></code></div>
          <div>â€¢ <code id="u3"></code></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // åªæŠ“ä½ ä¸‰å€‹ summary.jsonï¼ˆé‡é»éƒ½åœ¨ highlights è£¡ï¼‰
  const SOURCES = [
    {
      name: "è‚¡ç¥¨å¤–è³‡",
      url: "https://mis23ms.github.io/tw-stock-06/summary.json",
      page: "https://mis23ms.github.io/tw-stock-06/",
    },
    {
      name: "æœŸè²¨",
      url: "https://mis23ms.github.io/tw-stock-futures/summary.json",
      page: "https://mis23ms.github.io/tw-stock-futures/",
    },
    {
      name: "é¸æ“‡æ¬Š",
      url: "https://mis23ms.github.io/tw-stock-options/summary.json",
      page: "https://mis23ms.github.io/tw-stock-options/",
    },
  ];

  const $status = document.getElementById("status");
  const $list = document.getElementById("highlights");
  const $updatedAt = document.getElementById("updatedAt");
  const $count = document.getElementById("count");
  const $perSource = document.getElementById("perSource");

  document.getElementById("u1").textContent = SOURCES[0].url;
  document.getElementById("u2").textContent = SOURCES[1].url;
  document.getElementById("u3").textContent = SOURCES[2].url;

  function addItem(text, sourceName, link) {
    const li = document.createElement("li");

    const a = document.createElement("a");
    a.href = link;
    a.target = "_blank";
    a.rel = "noopener";
    a.textContent = text;
    a.style.color = "#111";
    a.style.textDecoration = "none";
    a.addEventListener("mouseover", () => a.style.textDecoration = "underline");
    a.addEventListener("mouseout", () => a.style.textDecoration = "none");

    const tag = document.createElement("span");
    tag.className = "tag";
    tag.textContent = sourceName;

    li.appendChild(a);
    li.appendChild(tag);
    $list.appendChild(li);
  }

  // summary.json çš„æ¨™æº–æ¬„ä½ï¼šupdatedAt
  function pickUpdatedAt(j) {
    return (j && (j.updatedAt || j.update_time || j.updateTime || j.generated_at || j.generatedAt)) ? String(
      j.updatedAt || j.update_time || j.updateTime || j.generated_at || j.generatedAt
    ) : "";
  }

  // âœ… åªåšä¸€ä»¶äº‹ï¼šæŠŠ highlights é¡¯ç¤ºå‡ºä¾†
  function extractHighlights(j) {
    const hs = (j && Array.isArray(j.highlights)) ? j.highlights : [];
    if (hs.length) return hs.filter(x => typeof x === "string" && x.trim()).slice(0, 12);

    const err = j?.error || j?.errors;
    if (err) return [`è³‡æ–™ä¾†æºå›å ±éŒ¯èª¤ï¼š${String(err).slice(0, 120)}`];

    if (j && typeof j === "object") {
      const keys = Object.keys(j);
      return [`(æ‰¾ä¸åˆ° highlights) æ¬„ä½ï¼š${keys.join(", ")}`];
    }
    return ["è³‡æ–™æ ¼å¼ä¸æ˜"];
  }

  function setPerSourceLine(lines) {
    $perSource.innerHTML = "";
    lines.forEach(t => {
      const div = document.createElement("div");
      div.textContent = t;
      $perSource.appendChild(div);
    });
  }

  async function loadAll() {
    $status.textContent = "è¼‰å…¥ä¸­â€¦";
    $list.innerHTML = "";
    $count.textContent = "0";
    $updatedAt.textContent = "â€”";
    setPerSourceLine([]);

    let total = 0;
    let latestTs = "";

    const results = await Promise.allSettled(
      SOURCES.map(async s => {
        const url = s.url + (s.url.includes("?") ? "&" : "?") + "t=" + Date.now(); // é˜²å¿«å–
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error(`${s.name} æŠ“å–å¤±æ•—ï¼š${r.status} ${r.statusText}`);
        const j = await r.json();
        return { source: s, json: j };
      })
    );

    const perSourceLines = [];

    for (const r of results) {
      if (r.status === "fulfilled") {
        const { source, json } = r.value;

        const ts = pickUpdatedAt(json);
        perSourceLines.push(`${source.name}: ${ts || "NA"}`);
        if (ts && (!latestTs || ts > latestTs)) latestTs = ts;

        const hs = extractHighlights(json);
        hs.forEach(line => {
          addItem(line, source.name, source.page);
          total++;
        });
      } else {
        perSourceLines.push(`(éŒ¯èª¤) ${r.reason?.message || "æŠ“å–å¤±æ•—"}`);
        addItem(r.reason?.message || "æŠ“å–å¤±æ•—", "ç¸½è¦½", "#");
        total++;
      }
    }

    setPerSourceLine(perSourceLines);
    $updatedAt.textContent = latestTs || "â€”";
    $count.textContent = String(total);
    $status.textContent = total ? `å…± ${total} å‰‡` : "ç›®å‰æ²’æœ‰é‡é»";
  }

  loadAll();
</script>
</body>
</html>


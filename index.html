<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æŠ•è³‡ç›£æ§ä¸­å¿ƒ</title>
  <style>
    body { font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif; margin: 24px; color:#111; }
    h1 { margin: 0 0 12px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin: 10px 0 18px; }
    .btn { display:inline-block; padding:10px 12px; border:1px solid #ddd; border-radius:12px; text-decoration:none; color:#111; }
    .card { border:1px solid #eee; border-radius:16px; padding:14px 16px; margin-top:14px; }
    .muted { color:#666; font-size:14px; }
    ul { margin: 10px 0 0 18px; }
    li { margin: 6px 0; }
    .tag { font-size:12px; padding:2px 8px; border:1px solid #ddd; border-radius:999px; margin-left:8px; color:#444; }
    .pill { font-size:12px; padding:2px 8px; border:1px solid #ddd; border-radius:999px; color:#444; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 860px) { .grid { grid-template-columns: 1fr 1fr; } }
    code { background:#f7f7f7; padding: 2px 6px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>ğŸ“Š æˆ‘çš„æŠ•è³‡ç›£æ§ä¸­å¿ƒ</h1>

  <div class="row">
    <a class="btn" href="https://mis23ms.github.io/tw-stock-06/" target="_blank" rel="noopener">è‚¡ç¥¨å¤–è³‡æˆ°å ±</a>
    <a class="btn" href="https://mis23ms.github.io/tw-stock-futures/" target="_blank" rel="noopener">æœŸè²¨å¤§é¡äº¤æ˜“äºº</a>
    <a class="btn" href="https://mis23ms.github.io/tw-stock-options/" target="_blank" rel="noopener">é¸æ“‡æ¬Šå¤§é¡äº¤æ˜“äºº</a>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="align-items:center; margin:0;">
        <h2 style="margin:0;">âš ï¸ ä»Šæ—¥é‡é»</h2>
        <span id="count" class="pill">0</span>
      </div>
      <div id="status" class="muted" style="margin-top:6px;">è¼‰å…¥ä¸­â€¦</div>
      <ul id="highlights"></ul>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px;">ğŸ•’ æœ€æ–°æ›´æ–°</h2>
      <div id="updatedAt" class="muted">â€”</div>
      <div class="muted" style="margin-top:10px;">
        è³‡æ–™ä¾†æºï¼ˆJSONï¼‰ï¼š
        <div style="margin-top:6px; line-height:1.7;">
          <div>â€¢ <code id="u1"></code></div>
          <div>â€¢ <code id="u2"></code></div>
          <div>â€¢ <code id="u3"></code></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // âœ… ç”¨ jsDelivr æŠ“ repo å…§ docs/*.jsonï¼ˆé€šå¸¸ä¸æœƒå¡ CORSï¼‰
const SOURCES = [
  {
    name: "è‚¡ç¥¨å¤–è³‡",
    url: "https://mis23ms.github.io/tw-stock-06/summary.json",
    page: "https://mis23ms.github.io/tw-stock-06/",
  },
  {
    name: "æœŸè²¨",
    url: "https://mis23ms.github.io/tw-stock-futures/summary.json",
    page: "https://mis23ms.github.io/tw-stock-futures/",
  },
  {
    name: "é¸æ“‡æ¬Š",
    url: "https://mis23ms.github.io/tw-stock-options/summary.json",
    page: "https://mis23ms.github.io/tw-stock-options/",
  },
];


  // ä½ è¦çš„ã€Œç•°å¸¸é–€æª»ã€å…ˆæ”¾å‰ç«¯ï¼šä¹‹å¾Œè¦èª¿åªæ”¹é€™è£¡
  const THRESHOLD_BIG_NEG = -5000; // ä¾‹å¦‚ï¼šæ·¨éƒ¨ä½ < -5000

  const $status = document.getElementById("status");
  const $list = document.getElementById("highlights");
  const $updatedAt = document.getElementById("updatedAt");
  const $count = document.getElementById("count");

  document.getElementById("u1").textContent = SOURCES[0].url;
  document.getElementById("u2").textContent = SOURCES[1].url;
  document.getElementById("u3").textContent = SOURCES[2].url;

  function addItem(text, sourceName, link) {
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.href = link;
    a.target = "_blank";
    a.rel = "noopener";
    a.textContent = text;
    a.style.color = "#111";
    a.style.textDecoration = "none";
    a.addEventListener("mouseover", () => a.style.textDecoration = "underline");
    a.addEventListener("mouseout", () => a.style.textDecoration = "none");

    const tag = document.createElement("span");
    tag.className = "tag";
    tag.textContent = sourceName;

    li.appendChild(a);
    li.appendChild(tag);
    $list.appendChild(li);
  }

  // å˜—è©¦å¾å„ç¨®å¯èƒ½æ¬„ä½æŠ“ã€Œæ›´æ–°æ™‚é–“ã€
  function pickUpdatedAt(j) {
    return j?.updatedAt || j?.update_time || j?.updateTime || j?.generated_at || j?.generatedAt || null;
  }

  // å˜—è©¦åšã€Œä»Šæ—¥é‡é»ã€ï¼šä¸ç¡¬ç¶ schemaï¼Œç”¨â€œç›¡å¯èƒ½æŠ“å¾—åˆ°çš„ç·šç´¢â€
  function extractHighlights(source, j) {
    const out = [];

    // 1) è‹¥å¾Œç«¯å·²æœ‰ errors / error
    const err = j?.error || j?.errors;
    if (err) out.push(`è³‡æ–™ä¾†æºå›å ±éŒ¯èª¤ï¼š${String(err).slice(0, 120)}`);

    // 2) é€šç”¨ï¼šè‹¥æœ‰ items arrayï¼Œæ‰¾å‡ºæœ€â€œè² â€çš„æ•¸å€¼ï¼ˆå¯èƒ½æ˜¯æ·¨éƒ¨ä½ï¼‰
    const items = Array.isArray(j?.items) ? j.items : null;
    if (items && items.length) {
      // æ‰¾å‡ºæ¯å€‹ item è£¡æœ€åƒã€Œæ·¨ã€çš„æ¬„ä½ï¼škey åŒ…å« net / æ·¨
      const candidates = [];
      for (const it of items) {
        if (!it || typeof it !== "object") continue;

        const name = it.name || it.ticker || it.symbol || it.code || "æ¨™çš„";
        for (const [k, v] of Object.entries(it)) {
          if (typeof v !== "number") continue;
          const kk = String(k).toLowerCase();
          if (kk.includes("net") || kk.includes("æ·¨")) {
            candidates.push({ name, k, v });
          }
        }
      }

      // è‹¥æŠ“å¾—åˆ°å€™é¸ï¼ŒæŒ‘å‡ºæœ€è² çš„å¹¾å€‹ç•¶é‡é»
      candidates.sort((a, b) => a.v - b.v);
      const worst = candidates.filter(x => x.v <= THRESHOLD_BIG_NEG).slice(0, 5);

      for (const x of worst) {
        out.push(`${x.name}ï¼š${x.k} ${x.v}`);
      }

      // å€™é¸å¤ªå°‘æ™‚ï¼Œè‡³å°‘ç§€ã€Œä»Šå¤©æœ‰å¹¾ç­† itemsã€
      if (!out.length) {
        out.push(`ä»Šæ—¥è³‡æ–™ç­†æ•¸ï¼š${items.length}`);
      }
    }

    // 3) stock06 è‹¥ä¸æ˜¯ items çµæ§‹ï¼Œä¹Ÿè‡³å°‘é¡¯ç¤ºã€Œæœ‰æ²’æœ‰é—œéµæ¨™çš„ã€
    //    ï¼ˆé€™æ®µåªåšéå¸¸ä¿å®ˆçš„æç¤ºï¼Œä¸å‡è¨­æ¬„ä½åç¨±ï¼‰
    if (!out.length && j && typeof j === "object") {
      const keys = Object.keys(j);
      out.push(`å·²è¼‰å…¥ï¼ˆæ¬„ä½ï¼š${keys.slice(0, 8).join(", ")}${keys.length > 8 ? "â€¦" : ""}ï¼‰`);
    }

    // æ§åˆ¶æ¯å€‹ä¾†æºæœ€å¤š 4 æ¢ï¼Œé¿å…å¤ªåµ
    return out.slice(0, 4);
  }

  async function loadAll() {
    $status.textContent = "è¼‰å…¥ä¸­â€¦";
    $list.innerHTML = "";
    $count.textContent = "0";

    let latest = null;
    let total = 0;

    const results = await Promise.allSettled(
      SOURCES.map(async s => {
        // cache bustï¼šé¿å… CDN å¿«å–è®“ä½ ä»¥ç‚ºæ²’æ›´æ–°
        const url = s.url + (s.url.includes("?") ? "&" : "?") + "t=" + Date.now();
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error(`${s.name} æŠ“å–å¤±æ•—ï¼š${r.status} ${r.statusText}`);
        const j = await r.json();
        return { source: s, json: j };
      })
    );

    for (const r of results) {
      if (r.status === "fulfilled") {
        const { source, json } = r.value;
        const ts = pickUpdatedAt(json);
        if (ts && (latest === null || String(ts) > String(latest))) latest = ts;

        const hs = extractHighlights(source, json);
        hs.forEach(t => { addItem(t, source.name, source.page); total++; });
      } else {
        addItem(r.reason?.message || "æŠ“å–å¤±æ•—", "ç¸½è¦½", "#");
        total++;
      }
    }

    $updatedAt.textContent = latest ? String(latest) : "â€”";
    $count.textContent = String(total);
    $status.textContent = total ? `å…± ${total} å‰‡` : "ç›®å‰æ²’æœ‰é‡é»";
  }

  loadAll();
</script>
</body>
</html>
